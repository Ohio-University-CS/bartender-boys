<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenAI Realtime API Client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            border: 1px solid #ccc;
            padding: 20px;
            margin: 10px 0;
            border-radius: 5px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .messages {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        .message.sent {
            background-color: #e3f2fd;
            text-align: right;
        }
        .message.received {
            background-color: #f3e5f5;
        }
        .message.error {
            background-color: #ffebee;
            color: #c62828;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>OpenAI Realtime API Client</h1>
    <div style="background-color: #d4edda; border: 1px solid #c3e6cb; padding: 10px; margin: 10px 0; border-radius: 5px;">
        <strong>Real Implementation:</strong> This client connects to the actual OpenAI Realtime API using WebSocket connections and ephemeral session tokens.
    </div>
    
    <div class="container">
        <h3>Connection Settings</h3>
        <label for="clientId">Client ID:</label>
        <input type="text" id="clientId" value="client1" placeholder="Enter client ID">
        <br><br>
        <button id="connectBtn" onclick="connect()">Connect to OpenAI</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
    </div>

    <div class="container">
        <h3>Status</h3>
        <div id="status" class="status disconnected">Disconnected</div>
        <div id="tokenInfo" style="display: none;">
            <strong>Token:</strong> <span id="tokenValue"></span><br>
            <strong>Expires:</strong> <span id="tokenExpiry"></span>
        </div>
    </div>

    <div class="container">
        <h3>Actions</h3>
        <button id="getTokenBtn" onclick="getToken()" disabled>Get Session Token</button>
        <button id="testConnectionBtn" onclick="testConnection()" disabled>Test OpenAI Connection</button>
        <button id="testFunctionBtn" onclick="testFunction()" disabled>Test Function Call</button>
        <button id="testRealtimeBtn" onclick="testRealtimeMessage()" disabled>Test Realtime Message</button>
        <button id="testConversationBtn" onclick="testConversation()" disabled>Test Conversation</button>
        <button id="testAudioBtn" onclick="testAudio()" disabled>Test Audio Buffer</button>
    </div>

    <div class="container">
        <h3>Messages</h3>
        <div id="messages" class="messages"></div>
        <button onclick="clearMessages()">Clear Messages</button>
    </div>

    <script>
        // Configuration
        const WS_URL = 'ws://localhost:8000/openai/realtime';
        
        // Global variables
        let websocket = null;
        let clientId = '';
        
        function updateStatus(message, isConnected = false) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${isConnected ? 'connected' : 'disconnected'}`;
        }
        
        function addMessage(message, type = 'received') {
            const messagesEl = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.textContent = JSON.stringify(message, null, 2);
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }
        
        function connect() {
            clientId = document.getElementById('clientId').value;
            
            if (!clientId) {
                alert('Please enter a Client ID');
                return;
            }
            
            const wsUrl = `${WS_URL}/${clientId}`;
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = function() {
                updateStatus(`Connected to OpenAI Realtime API as ${clientId}`, true);
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                document.getElementById('getTokenBtn').disabled = false;
                document.getElementById('testConnectionBtn').disabled = false;
                document.getElementById('testFunctionBtn').disabled = false;
                document.getElementById('testRealtimeBtn').disabled = false;
                document.getElementById('testConversationBtn').disabled = false;
                document.getElementById('testAudioBtn').disabled = false;
                addMessage({ type: 'connection', message: 'Connected to OpenAI Realtime API' }, 'sent');
            };
            
            websocket.onmessage = function(event) {
                const message = JSON.parse(event.data);
                addMessage(message, 'received');
                handleServerMessage(message);
            };
            
            websocket.onclose = function() {
                updateStatus('Disconnected', false);
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                document.getElementById('getTokenBtn').disabled = true;
                document.getElementById('testConnectionBtn').disabled = true;
                document.getElementById('testFunctionBtn').disabled = true;
                document.getElementById('testRealtimeBtn').disabled = true;
                document.getElementById('testConversationBtn').disabled = true;
                document.getElementById('testAudioBtn').disabled = true;
                document.getElementById('tokenInfo').style.display = 'none';
            };
            
            websocket.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateStatus('Connection error', false);
                addMessage({ type: 'error', message: 'WebSocket connection error' }, 'error');
            };
        }
        
        function disconnect() {
            if (websocket) {
                websocket.close();
            }
        }
        
        function handleServerMessage(message) {
            switch (message.type) {
                case 'token_response':
                    document.getElementById('tokenValue').textContent = message.session_id || message.token;
                    document.getElementById('tokenExpiry').textContent = `${message.expires_in} seconds`;
                    document.getElementById('tokenInfo').style.display = 'block';
                    break;
                case 'session_created':
                    updateStatus(`Session created: ${message.session_id}`, true);
                    addMessage({ type: 'session_created', message: `OpenAI session created with ID: ${message.session_id}` }, 'received');
                    break;
                case 'session.created':
                    updateStatus(`OpenAI session ready: ${message.session.id}`, true);
                    addMessage({ type: 'session_ready', message: `OpenAI session ready! Model: ${message.session.model}, Voice: ${message.session.voice}` }, 'received');
                    break;
                case 'conversation.item.created':
                    addMessage({ type: 'item_created', message: `Conversation item created: ${message.item.type}` }, 'received');
                    break;
                case 'response.audio.delta':
                    addMessage({ type: 'audio_response', message: `Audio response received (${message.delta.length} bytes)` }, 'received');
                    break;
                case 'response.audio_transcript.delta':
                    addMessage({ type: 'ai_response', message: `AI: ${message.delta}` }, 'received');
                    break;
                case 'response.text.delta':
                    addMessage({ type: 'text_response', message: `Text response: ${message.delta}` }, 'received');
                    break;
                case 'response.created':
                    addMessage({ type: 'response_started', message: `AI response started: ${message.response.id}` }, 'received');
                    break;
                case 'response.output_item.added':
                    addMessage({ type: 'response_item', message: `AI response item added` }, 'received');
                    break;
                case 'error':
                    addMessage(message, 'error');
                    break;
            }
        }
        
        function getToken() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                const message = { type: 'get_token' };
                websocket.send(JSON.stringify(message));
                addMessage(message, 'sent');
            }
        }
        
        async function testConnection() {
            const clientId = document.getElementById('clientId').value;
            try {
                const response = await fetch(`http://localhost:8000/openai/connect/${clientId}`, {
                    method: 'POST'
                });
                const result = await response.json();
                addMessage({ type: 'connection_test', result: result }, 'received');
            } catch (error) {
                addMessage({ type: 'error', message: `Connection test failed: ${error.message}` }, 'error');
            }
        }
        
        function testFunction() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                const message = {
                    type: 'function_call',
                    function_name: 'check_id',
                    arguments: { id_number: '123456789' }
                };
                websocket.send(JSON.stringify(message));
                addMessage(message, 'sent');
            }
        }
        
        function testRealtimeMessage() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                const message = {
                    type: 'conversation.item.create',
                    item: {
                        type: 'message',
                        role: 'user',
                        content: [{
                            type: 'input_text',
                            text: 'Test message from client'
                        }]
                    }
                };
                websocket.send(JSON.stringify(message));
                addMessage(message, 'sent');
            }
        }
        
        function testConversation() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                const message = {
                    type: 'conversation.item.create',
                    item: {
                        type: 'message',
                        role: 'user',
                        content: [
                            {
                                type: 'input_text',
                                text: 'Hello! I would like to order a drink.'
                            }
                        ]
                    }
                };
                websocket.send(JSON.stringify(message));
                addMessage(message, 'sent');
                
                // Request AI response after sending message
                setTimeout(() => {
                    const responseRequest = {
                        type: 'response.create'
                    };
                    websocket.send(JSON.stringify(responseRequest));
                    addMessage(responseRequest, 'sent');
                }, 1000);
            }
        }
        
        function testAudio() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                // Create a conversation item first
                const createMessage = {
                    type: 'conversation.item.create',
                    item: {
                        type: 'input_audio_buffer',
                        audio_buffer: {
                            format: 'pcm16',
                            sample_rate: 24000,
                            channels: 1
                        }
                    }
                };
                websocket.send(JSON.stringify(createMessage));
                addMessage(createMessage, 'sent');
                
                // Then append some test audio data
                setTimeout(() => {
                    const appendMessage = {
                        type: 'conversation.item.input_audio_buffer.append',
                        item_id: 'test-audio-item',
                        audio_buffer: {
                            format: 'pcm16',
                            sample_rate: 24000,
                            channels: 1,
                            data: 'base64-encoded-audio-data-here'
                        }
                    };
                    websocket.send(JSON.stringify(appendMessage));
                    addMessage(appendMessage, 'sent');
                }, 100);
            }
        }
        
        // Auto-connect on page load for testing
        window.onload = function() {
            // Uncomment the line below to auto-connect for testing
            // connect();
        };
    </script>
</body>
</html>
